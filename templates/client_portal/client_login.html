
{% extends "client_portal/base.html" %}
{% block title %} • Auth{% endblock %}
{% block content %}
<section class="max-w-5xl mx-auto mt-12 font-semibold">
  <div class="grid md:grid-cols-5 gap-0 rounded-2xl border border-gray-200 dark:border-[#2a2a2a] overflow-hidden shadow-xl bg-white dark:bg-[#1f1f1f] text-gray-900 dark:text-[#e5e5e5]">
    <!-- Left: Hero / copy -->
    <div class="hidden md:flex md:col-span-2 flex-col justify-center p-8 bg-gradient-to-br from-emerald-600/80 to-lime-600/60 text-white">
      <h2 class="text-2xl font-extrabold mb-2">Welcome to FloDo Portal</h2>
      <p class="text-white/90">Browse artists, book services, and manage your account. Toggle dark mode anytime using the header switch.</p>
      <div class="mt-6 text-sm text-white/90">
        <p>• No signup required to browse</p>
        <p>• Create an account to track bookings</p>
        <p>• Secure login with your phone or email</p>
      </div>
    </div>

    <!-- Right: Auth Card -->
    <div class="md:col-span-3 w-full p-8 sm:p-10">
      <!-- Tabs -->
      <div class="flex items-center gap-2 mb-6">
        <button id="tab-login" class="tab-btn py-3 px-5 inline-flex items-center gap-x-2 text-base md:text-lg font-semibold rounded-full bg-neutral-900 text-white hover:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-neutral-500/60 dark:bg-white dark:text-neutral-900 dark:hover:bg-neutral-100">Sign In</button>
        <button id="tab-signup" class="tab-btn py-3 px-5 inline-flex items-center gap-x-2 text-base md:text-lg font-semibold rounded-full border border-neutral-500 text-neutral-700 dark:text-neutral-200 hover:bg-neutral-100/10 focus:outline-none">Create Account</button>
      </div>

      <!-- Alerts -->
      <div id="auth-alert" class="hidden mb-4 px-3 py-2 rounded-lg text-sm" role="status" aria-live="polite"></div>

      <!-- Sign In Form -->
      <form id="form-login" class="space-y-4" autocomplete="on" method="post" action="{% url 'client_portal:client_api_login' %}">
        {% csrf_token %}
        <!-- Honeypot anti-bot field (hidden). Legit users won't see/fill this. -->
        <input type="text" name="hp_company" tabindex="-1" autocomplete="off" aria-hidden="true" class="hidden" style="display:none" />
        <div class="relative group">
          <label for="login-identifier" class="block text-sm text-gray-800">Phone or Email</label>
          <span class="pointer-events-none absolute left-3 top-10 sm:top-9 text-gray-400 group-focus-within:text-neutral-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M2 4.5A2.5 2.5 0 014.5 2h15A2.5 2.5 0 0122 4.5v15a2.5 2.5 0 01-2.5 2.5h-15A2.5 2.5 0 012 19.5v-15zm3 2A1.5 1.5 0 006.5 8h11A1.5 1.5 0 0019 6.5V6a1 1 0 00-1-1H6a1 1 0 00-1 1v.5zM5 10v9.5a.5.5 0 00.5.5h13a.5.5 0 00.5-.5V10H5z"/></svg>
          </span>
          <input id="login-identifier" name="identifier" required aria-describedby="login-identifier-hint" autocomplete="username" placeholder="you@example.com or +1 555 000 0000" class="mt-1 w-full border rounded-full pl-9 pr-3 py-2.5 bg-white dark:bg-[#222222] border-gray-300 dark:border-[#333333] text-gray-900 dark:text-[#eaeaea] focus:outline-none focus:ring-2 focus:ring-neutral-500/60" />
          <p id="login-identifier-hint" class="mt-1 text-xs text-gray-500">Use your email or phone number.</p>
          <p class="hidden mt-1 text-xs text-red-600" id="login-identifier-error">Please enter a valid email or phone number.</p>
        </div>
        <div class="relative group">
          <label for="login-password" class="block text-sm text-gray-800">Password</label>
          <span class="pointer-events-none absolute left-3 top-10 sm:top-9 text-gray-400 group-focus-within:text-neutral-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 1a5 5 0 00-5 5v3H6a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2v-8a2 2 0 00-2-2h-1V6a5 5 0 00-5-5zm-3 8V6a3 3 0 116 0v3H9z"/></svg>
          </span>
          <input id="login-password" type="password" name="password" autocomplete="current-password" required placeholder="••••••••" class="mt-1 w-full border rounded-full pl-9 pr-10 py-2.5 bg-white dark:bg-[#222222] border-gray-300 dark:border-[#333333] text-gray-900 dark:text-[#eaeaea] focus:outline-none focus:ring-2 focus:ring-neutral-500/60" />
          <button type="button" class="absolute right-2 top-9 sm:top-8 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-[#2a2a2a]" id="toggle-login-password" aria-label="Show password">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 5c-5 0-9.27 3.11-11 7 1.73 3.89 6 7 11 7s9.27-3.11 11-7c-1.73-3.89-6-7-11-7zm0 12a5 5 0 110-10 5 5 0 010 10z"/></svg>
          </button>
          <div class="mt-2 flex items-center justify-between">
            <label class="inline-flex items-center gap-2 text-sm text-gray-800 dark:text-[#e5e5e5]">
              <input type="checkbox" name="remember" class="h-4 w-4 rounded border-gray-300 dark:border-[#333333] text-neutral-900 focus:ring-neutral-600 dark:text-neutral-900" />
              Remember me
            </label>
          </div>
        </div>
        <div class="flex items-center justify-between gap-3">
          <button type="submit" class="relative inline-flex items-center gap-x-2 py-3 px-5 text-base md:text-lg font-semibold rounded-full bg-neutral-900 hover:bg-neutral-800 text-white disabled:opacity-70 disabled:cursor-not-allowed focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-neutral-500/60 dark:bg-white dark:text-neutral-900 dark:hover:bg-neutral-100">
            <svg class="spinner hidden h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><circle class="opacity-25" cx="12" cy="12" r="10" stroke-width="4"></circle><path class="opacity-75" d="M4 12a8 8 0 018-8" stroke-width="4" stroke-linecap="round"></path></svg>
            <span class="btn-text">Sign In</span>
            <svg class="success-check hidden h-4 w-4" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M9 12.75l-2-2a1 1 0 10-1.414 1.414l2.707 2.707a1 1 0 001.414 0L19 8.586A1 1 0 1017.586 7.17L9 15.75z"/></svg>
          </button>
          <a class="underline text-sm" href="{% url 'client_portal:client_forgot_password' %}">Forgot password?</a>
        </div>
      </form>

      

      <!-- Sign Up Form -->
      <form id="form-signup" class="space-y-4 hidden" autocomplete="on" method="post" action="{% url 'client_portal:client_api_signup' %}">
        {% csrf_token %}
        <!-- Honeypot anti-bot field (hidden). Legit users won't see/fill this. -->
        <input type="text" name="hp_company" tabindex="-1" autocomplete="off" aria-hidden="true" class="hidden" style="display:none" />
        <div class="grid sm:grid-cols-2 gap-3">
          <div>
            <label for="signup-fullname" class="block text-sm text-gray-800">Full name</label>
            <input id="signup-fullname" name="full_name" required placeholder="John Doe" class="mt-1 w-full border rounded-full px-4 py-2.5 bg-white dark:bg-white border-gray-300 dark:border-gray-200 text-gray-900 dark:text-neutral-900 focus:outline-none focus:ring-2 focus:ring-neutral-500/60" />
          </div>
          <div>
            <label for="signup-phone" class="block text-sm text-gray-800">Phone</label>
            <div class="relative group">
              <span class="pointer-events-none absolute left-3 top-3 text-gray-400 group-focus-within:text-neutral-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M6.62 10.79a15.05 15.05 0 006.59 6.59l2.2-2.2a1 1 0 011.01-.24 11.36 11.36 0 003.56.57 1 1 0 011 1v3.6a1 1 0 01-1 1A17 17 0 013 5a1 1 0 011-1h3.6a1 1 0 011 1 11.36 11.36 0 00.57 3.56 1 1 0 01-.24 1.01l-2.31 2.22z"/></svg>
              </span>
              <input id="signup-phone" name="phone" required inputmode="tel" placeholder="+1 555 000 0000" class="mt-1 w-full border rounded-full pl-9 pr-3 py-2.5 bg-white dark:bg-[#222222] border-gray-300 dark:border-[#333333] text-gray-900 dark:text-[#eaeaea] focus:outline-none focus:ring-2 focus:ring-neutral-500/60" />
            </div>
          </div>
        </div>
        <div class="grid sm:grid-cols-2 gap-3">
          <div>
            <label for="signup-email" class="block text-sm text-gray-800">Email (optional)</label>
            <div class="relative group">
              <span class="pointer-events-none absolute left-3 top-3 text-gray-400 group-focus-within:text-emerald-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M2 5.5A2.5 2.5 0 014.5 3h15A2.5 2.5 0 0122 5.5v13a2.5 2.5 0 01-2.5 2.5h-15A2.5 2.5 0 012 18.5v-13zm2.5-.5a.5.5 0 00-.5.5v.3l8 5 8-5V5.5a.5.5 0 00-.5-.5h-15z"/></svg>
              </span>
              <input id="signup-email" type="email" name="email" placeholder="you@example.com" aria-describedby="signup-email-hint" class="mt-1 w-full border rounded-full pl-9 pr-3 py-2.5 bg-white dark:bg-[#222222] border-gray-300 dark:border-[#333333] text-gray-900 dark:text-[#eaeaea] focus:outline-none focus:ring-2 focus:ring-neutral-500/60" />
            </div>
            <p id="signup-email-hint" class="mt-1 text-xs text-gray-500">We’ll use this for receipts and notifications.</p>
            <p id="signup-email-error" class="hidden mt-1 text-xs text-red-600">Please enter a valid email (e.g., name@domain.com).</p>
          </div>
          <div>
            <label for="signup-password" class="block text-sm text-gray-800">Password</label>
            <div class="relative group">
              <span class="pointer-events-none absolute left-3 top-3 text-gray-400 group-focus-within:text-emerald-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 1a5 5 0 00-5 5v3H6a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2v-8a2 2 0 00-2-2h-1V6a5 5 0 00-5-5zm-3 8V6a3 3 0 116 0v3H9z"/></svg>
              </span>
              <input id="signup-password" type="password" name="password" autocomplete="new-password" required aria-describedby="pwd-hint" placeholder="At least 8 characters" class="mt-1 w-full border rounded-full pl-9 pr-10 py-2.5 bg-white dark:bg-[#222222] border-gray-300 dark:border-[#333333] text-gray-900 dark:text-[#eaeaea] focus:outline-none focus:ring-2 focus:ring-neutral-500/60" />
              <button type="button" class="absolute right-2 top-2.5 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-[#2a2a2a]" id="toggle-signup-password" aria-label="Show password">
                <svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 5c-5 0-9.27 3.11-11 7 1.73 3.89 6 7 11 7s9.27-3.11 11-7c-1.73-3.89-6-7-11-7zm0 12a5 5 0 110-10 5 5 0 010 10z"/></svg>
              </button>
            </div>
            <div class="mt-2" aria-live="polite">
              <div class="h-1.5 rounded-full bg-gray-200 dark:bg-[#2a2a2a] overflow-hidden">
                <div id="pwd-bar" class="h-1.5 bg-red-500 w-1/5 transition-all"></div>
              </div>
              <p id="pwd-hint" class="mt-1 text-xs text-gray-500">Use 8+ chars with upper, lower, number, and symbol.</p>
            </div>
          </div>
        </div>
        <div>
          <label class="block text-sm text-gray-800 dark:text-[#e5e5e5]">Location (optional)</label>
          <input name="location" class="mt-1 w-full border rounded-full px-4 py-2.5 bg-white dark:bg-[#222222] border-gray-300 dark:border-[#333333] text-gray-900 dark:text-[#eaeaea] focus:outline-none focus:ring-2 focus:ring-neutral-500/60" />
        </div>
        <div class="flex items-center justify-end gap-3">
          <button type="submit" class="relative inline-flex items-center gap-x-2 py-3 px-4 text-sm font-medium rounded-full bg-neutral-900 hover:bg-neutral-800 text-white disabled:opacity-70 disabled:cursor-not-allowed focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-neutral-500/60 dark:bg-white dark:text-neutral-900 dark:hover:bg-neutral-100">
            <svg class="spinner hidden h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><circle class="opacity-25" cx="12" cy="12" r="10" stroke-width="4"></circle><path class="opacity-75" d="M4 12a8 8 0 018-8" stroke-width="4" stroke-linecap="round"></path></svg>
            <span class="btn-text">Create Account</span>
            <svg class="success-check hidden h-4 w-4" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M9 12.75l-2-2a1 1 0 10-1.414 1.414l2.707 2.707a1 1 0 001.414 0L19 8.586A1 1 0 1017.586 7.17L9 15.75z"/></svg>
          </button>
        </div>
      </form>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script nonce="{{ csp_nonce }}">
  (function(){
    const qs = (s, r=document) => r.querySelector(s);
    window.initAuthPage = function(){
      const alertBox = qs('#auth-alert');
      const tabLogin = qs('#tab-login');
      const tabSignup = qs('#tab-signup');
      const formLogin = qs('#form-login');
      const formSignup = qs('#form-signup');

      function showAlert(msg, ok){
        if(!alertBox) return;
        alertBox.classList.remove('hidden');
        alertBox.textContent = msg;
        alertBox.className = 'mb-4 px-3 py-2 rounded-lg text-sm ' + (ok ? 'bg-neutral-900/20 text-neutral-200 border border-neutral-600/40' : 'bg-red-600/20 text-red-200 border border-red-500/40');
      }
      function clearAlert(){ if(alertBox){ alertBox.classList.add('hidden'); alertBox.textContent=''; } }

      function setTab(which){
        if(tabLogin && tabSignup && formLogin && formSignup){
          if(which === 'login'){
            tabLogin.classList.add('bg-neutral-900','text-white');
            tabLogin.classList.add('dark:bg-white','dark:text-neutral-900');
            tabSignup.classList.remove('bg-neutral-900','text-white','dark:bg-white','dark:text-neutral-900');
            formLogin.classList.remove('hidden');
            formSignup.classList.add('hidden');
          } else {
            tabSignup.classList.add('bg-neutral-900','text-white');
            tabSignup.classList.add('dark:bg-white','dark:text-neutral-900');
            tabLogin.classList.remove('bg-neutral-900','text-white','dark:bg-white','dark:text-neutral-900');
            formSignup.classList.remove('hidden');
            formLogin.classList.add('hidden');
          }
        }
        clearAlert();
      }
      if(tabLogin) tabLogin.addEventListener('click', e=>{e.preventDefault(); setTab('login');});
      if(tabSignup) tabSignup.addEventListener('click', e=>{e.preventDefault(); setTab('signup');});

      async function postForm(url, form){
        const data = new FormData(form);
        const res = await fetch(url, {
          method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' }, body: data, credentials: 'same-origin'
        });
        const json = await res.json().catch(()=>({ok:false,error:'Invalid server response'}));
        if(!res.ok || !json.ok){ throw new Error(json.error||('HTTP '+res.status)); }
        return json;
      }

      function validateIdentifier(value){
        const email = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const phone = /^[+]?\d[\d\s-]{6,}$/;
        return email.test(value) || phone.test(value);
      }
      function updatePasswordStrength(pwd){
        let score = 0; if(pwd.length >= 8) score++; if(/[a-z]/.test(pwd)) score++; if(/[A-Z]/.test(pwd)) score++; if(/\d/.test(pwd)) score++; if(/[^A-Za-z0-9]/.test(pwd)) score++;
        const bar = document.getElementById('pwd-bar'); if(!bar) return;
        const widths = ['w-1/5','w-2/5','w-3/5','w-4/5','w-full'];
        bar.className = 'h-1.5 transition-all ' + (score<=2?'bg-red-500':score===3?'bg-amber-500':'bg-neutral-500') + ' ' + widths[Math.max(0, Math.min(score-1, 4))];
      }
      function attachToggle(btnId, inputId){
        const btn = document.getElementById(btnId); const inp = document.getElementById(inputId);
        if(!btn || !inp) return; btn.addEventListener('click', ()=>{ const isPwd = inp.type === 'password'; inp.type = isPwd ? 'text' : 'password'; btn.setAttribute('aria-label', isPwd ? 'Hide password' : 'Show password'); });
      }

      const loginId = document.getElementById('login-identifier');
      const loginIdErr = document.getElementById('login-identifier-error');
      if(loginId && loginIdErr){
        loginId.addEventListener('input', ()=>{
          const ok = validateIdentifier(loginId.value.trim());
          loginId.classList.toggle('border-red-500', !ok && loginId.value.length>0);
          loginId.setAttribute('aria-invalid', (!ok && loginId.value.length>0).toString());
          loginIdErr.classList.toggle('hidden', ok || loginId.value.length===0);
        });
      }
      const signupPwd = document.getElementById('signup-password');
      if(signupPwd){ signupPwd.addEventListener('input', ()=> updatePasswordStrength(signupPwd.value)); }
      attachToggle('toggle-login-password','login-password');
      attachToggle('toggle-signup-password','signup-password');

      if(formLogin){
        formLogin.addEventListener('submit', async (e)=>{
          e.preventDefault(); clearAlert();
          try{
            setLoading(formLogin, true);
            const json = await postForm('{% url "client_portal:client_api_login" %}', formLogin);
            showAlert('Signed in. Redirecting...', true);
            const to = (json && json.redirect) || '{% url "client_portal:customer_dashboard" %}';
            setTimeout(()=>{ window.location.assign(to); }, 400);
          }catch(err){ showAlert(err.message||'Login failed', false); }
          finally { setLoading(formLogin, false); }
        });
      }
      if(formSignup){
        formSignup.addEventListener('submit', async (e)=>{
          e.preventDefault(); clearAlert();
          try{
            setLoading(formSignup, true);
            const json = await postForm('{% url "client_portal:client_api_signup" %}', formSignup);
            if (json && json.redirect){
              showAlert('Account created. Redirecting...', true);
              setTimeout(()=>{ window.location.assign(json.redirect); }, 400);
              return;
            }
            showAlert('Account created. Please sign in.', true);
            setTab('login');
          }catch(err){ showAlert(err.message||'Signup failed', false); }
          finally { setLoading(formSignup, false); }
        });
      }

      function setLoading(form, loading){
        try{
          const btn = form.querySelector('button[type="submit"]'); if(!btn) return;
          const spinner = btn.querySelector('.spinner'); const text = btn.querySelector('.btn-text'); const check = btn.querySelector('.success-check');
          btn.disabled = !!loading; const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
          if(spinner) { spinner.classList.toggle('hidden', !loading); spinner.classList.toggle('animate-spin', !prefersReduced && loading); }
          if(text) text.textContent = loading ? 'Working…' : (btn === (formLogin && formLogin.querySelector('button[type="submit"]')) ? 'Sign In' : 'Create Account');
          if(!loading && check){ check.classList.remove('hidden'); setTimeout(()=>{ try { check.classList.add('hidden'); } catch(_){} }, 500); }
        }catch(_){ }
      }

      setTab('login');
    };

    // Initialize on first load
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', function(){ try{ window.initAuthPage && window.initAuthPage(); }catch(_){} });
    else { try{ window.initAuthPage && window.initAuthPage(); }catch(_){} }

    // Added: show toast if forced logout occurred due to another login
    try { var r=new URLSearchParams(location.search).get('reason'); if(r==='session_ended'){ var a=document.getElementById('auth-alert'); if(a){ a.classList.remove('hidden'); a.textContent='Your previous session ended because you signed in elsewhere.'; a.className='mb-4 px-3 py-2 rounded-lg text-sm bg-neutral-900/20 text-neutral-200 border border-neutral-600/40'; } } } catch(_){ }
  })();
</script>
{% endblock %}
