{% extends 'base.html' %}
{% block title %} Â· Dashboard{% endblock %}
{% block content %}
  <!-- Dashboard Overview: lightweight stats instead of heavy CRUD tables (keeps dashboard fast) -->
  <h1 class="text-2xl font-semibold text-blue-700 dark:text-blue-300 mb-2">Dashboard Overview</h1> <!-- Renamed heading to reflect overview role -->
  <p class="text-sm text-gray-600 dark:text-gray-300 mb-6">Key stats and quick actions. Use the Tables page for full CRUD and details.</p> <!-- Clarifies separation of concerns -->

  <!-- Summary badges: total rows and recent activity count (server-provided aggregates) -->
    <div class="flex flex-wrap gap-3 mb-4"> <!-- Reduced spacing -->
      <div class="px-2 py-1 bg-white dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700 shadow-sm"> <!-- Smaller badge -->
        <div class="text-[10px] text-gray-500 dark:text-gray-400">Total Rows</div>
        <div class="text-sm font-semibold text-gray-900 dark:text-gray-100">{{ total_rows }}</div>
      </div>
      <div class="px-2 py-1 bg-white dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-700 shadow-sm"> <!-- Smaller badge -->
        <div class="text-[10px] text-gray-500 dark:text-gray-400">Activity Entries</div>
        <div class="text-sm font-semibold text-gray-900 dark:text-gray-100">{{ recent_logs_count }}</div>
      </div>
      <a href="/dashboard/tables/"
        class="px-2 py-1 bg-blue-600 text-white rounded shadow-sm text-sm inline-flex items-center justify-center">
        Go to Tables
      </a>
    </div>

  <!-- Per-table mini cards: show counts and a quick deep-link action reusing existing AJAX loader -->
  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-5 gap-4"> <!-- Responsive, modern grid -->
    {% for stat in table_stats %} <!-- Use server-provided list to avoid custom filters -->
      <div class="group relative overflow-hidden bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-lg transition-all duration-200 p-5 flex flex-col min-h-[150px]"> <!-- Modern card -->
        <div class="absolute inset-0 pointer-events-none bg-gradient-to-br from-blue-500/5 via-transparent to-transparent dark:from-blue-400/5"></div>
        <div class="flex items-start justify-between mb-1">
          <h3 class="font-semibold text-gray-900 dark:text-gray-100 tracking-tight">{{ stat.label }}</h3>
          <span class="text-[11px] text-gray-500 dark:text-gray-400 select-none">rows</span>
        </div>
        <div class="mt-1 text-3xl font-extrabold text-gray-900 dark:text-gray-100">{{ stat.count }}</div>
        <div class="mt-auto pt-4">
          <a href="/dashboard/tables/" class="inline-flex items-center gap-2 text-sm px-3 py-1.5 rounded-lg bg-blue-50 text-blue-700 border border-blue-200 hover:bg-blue-100 dark:bg-blue-900/20 dark:text-blue-300 dark:border-blue-800 dark:hover:bg-blue-900/30 transition-colors">
            Open in Tables
          </a>
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- Key Entities (Donut Charts) -->
  <div id="donut-cards" class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4 auto-rows-fr"
       data-stats='[
       {% for stat in table_stats %}{% if not forloop.first %},{% endif %}{"label":"{{ stat.label|escapejs }}","count":{{ stat.count|default:0 }}}{% endfor %}
       ]'>
    <!-- Users -->
    <div class="group relative overflow-hidden bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-lg transition-all duration-200 p-5 md:p-6 lg:p-8" title="Users share out of Users, Artists and Bookings">
      <div class="absolute inset-0 bg-gradient-to-br from-blue-500/6 via-transparent to-transparent dark:from-blue-400/10 pointer-events-none"></div>
      <div class="flex items-start justify-between mb-2 md:mb-3">
        <h3 class="text-sm font-semibold text-gray-900 dark:text-gray-100 tracking-tight">Users</h3>
        <span class="inline-flex items-center gap-1.5 text-[11px] md:text-xs font-semibold px-2.5 py-1 rounded-full bg-green-50 text-green-700 dark:bg-green-900/25 dark:text-green-300 border border-green-200 dark:border-green-800">
          <span class="relative inline-flex items-center justify-center">
            <span class="absolute inline-flex w-2 h-2 rounded-full bg-green-400/60 dark:bg-green-300/50 animate-ping"></span>
            <span class="relative w-2 h-2 rounded-full bg-green-500 dark:bg-green-400 animate-pulse"></span>
          </span>
          Live
        </span>
      </div>
      <div id="donut-users" class="h-44 md:h-56 xl:h-64"></div>
      <div class="mt-3 md:mt-4 text-xs md:text-sm text-gray-600 dark:text-gray-300 flex items-center gap-2">
        <span class="inline-flex items-center gap-1 font-medium">
          <svg class="w-3.5 h-3.5 text-blue-500" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M10 2a8 8 0 100 16 8 8 0 000-16Zm1 11H9v-1h2v1Zm0-3H9V5h2v5Z"/></svg>
          Share relative to Users, Artists, Bookings
        </span>
        <span class="ms-auto text-gray-700 dark:text-gray-200">
          {% for s in table_stats %}{% if s.label == 'User' %}Total: <strong>{{ s.count }}</strong>{% endif %}{% endfor %}
        </span>
        <span id="users-pct" class="ms-2 inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold bg-blue-50 text-blue-700 dark:bg-blue-900/20 dark:text-blue-300 border border-blue-200 dark:border-blue-800">0%</span>
      </div>
    </div>
    <!-- Artists -->
    <div class="group relative overflow-hidden bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-lg transition-all duration-200 p-5 md:p-6 lg:p-8" title="Artists share out of Users, Artists and Bookings">
      <div class="absolute inset-0 bg-gradient-to-br from-emerald-500/6 via-transparent to-transparent dark:from-emerald-400/10 pointer-events-none"></div>
      <div class="flex items-start justify-between mb-2 md:mb-3">
        <h3 class="text-sm font-semibold text-gray-900 dark:text-gray-100 tracking-tight">Artists</h3>
        <span class="inline-flex items-center gap-1.5 text-[11px] md:text-xs font-semibold px-2.5 py-1 rounded-full bg-green-50 text-green-700 dark:bg-green-900/25 dark:text-green-300 border border-green-200 dark:border-green-800">
          <span class="w-2 h-2 rounded-full bg-green-500 dark:bg-green-400 animate-pulse"></span>
          Live
        </span>
      </div>
      <div id="donut-artists" class="h-44 md:h-56 xl:h-64"></div>
      <div class="mt-3 md:mt-4 text-xs md:text-sm text-gray-600 dark:text-gray-300 flex items-center gap-2">
        <span class="inline-flex items-center gap-1 font-medium">
          <svg class="w-3.5 h-3.5 text-emerald-500" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M10 2a8 8 0 100 16 8 8 0 000-16Zm1 11H9v-1h2v1Zm0-3H9V5h2v5Z"/></svg>
          Share relative to Users, Artists, Bookings
        </span>
        <span class="ms-auto text-gray-700 dark:text-gray-200">
          {% for s in table_stats %}{% if s.label == 'Verified Artist' or s.label == 'Artist' or s.label == 'Artists' %}Total: <strong>{{ s.count }}</strong>{% endif %}{% endfor %}
        </span>
        <span id="artists-pct" class="ms-2 inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold bg-emerald-50 text-emerald-700 dark:bg-emerald-900/20 dark:text-emerald-300 border border-emerald-200 dark:border-emerald-800">0%</span>
      </div>
    </div>
    <!-- Bookings -->
    <div class="group relative overflow-hidden bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-lg transition-all duration-200 p-5 md:p-6 lg:p-8" title="Bookings share out of Users, Artists and Bookings">
      <div class="absolute inset-0 bg-gradient-to-br from-amber-500/6 via-transparent to-transparent dark:from-amber-400/10 pointer-events-none"></div>
      <div class="flex items-start justify-between mb-2 md:mb-3">
        <h3 class="text-sm font-semibold text-gray-900 dark:text-gray-100 tracking-tight">Bookings</h3>
        <span class="inline-flex items-center gap-1.5 text-[11px] md:text-xs font-semibold px-2.5 py-1 rounded-full bg-green-50 text-green-700 dark:bg-green-900/25 dark:text-green-300 border border-green-200 dark:border-green-800">
          <span class="w-2 h-2 rounded-full bg-green-500 dark:bg-green-400 animate-pulse"></span>
          Live
        </span>
      </div>
      <div id="donut-bookings" class="h-44 md:h-56 xl:h-64"></div>
      <div class="mt-3 md:mt-4 text-xs md:text-sm text-gray-600 dark:text-gray-300 flex items-center gap-2">
        <span class="inline-flex items-center gap-1 font-medium">
          <svg class="w-3.5 h-3.5 text-amber-500" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M10 2a8 8 0 100 16 8 8 0 000-16Zm1 11H9v-1h2v1Zm0-3H9V5h2v5Z"/></svg>
          Share relative to Users, Artists, Bookings
        </span>
        <span class="ms-auto text-gray-700 dark:text-gray-200">
          {% for s in table_stats %}{% if s.label == 'Booking' or s.label == 'Bookings' %}Total: <strong>{{ s.count }}</strong>{% endif %}{% endfor %}
        </span>
        <span id="bookings-pct" class="ms-2 inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold bg-amber-50 text-amber-700 dark:bg-amber-900/20 dark:text-amber-300 border border-amber-200 dark:border-amber-800">0%</span>
      </div>
    </div>
  </div>

  <!-- Data Overview (Charts) -->
  <div class="mt-8 group relative bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-lg transition-all duration-200 overflow-hidden">
    <div class="absolute inset-0 bg-gradient-to-br from-indigo-500/8 via-transparent to-transparent dark:from-indigo-400/10 pointer-events-none"></div>
    <div class="px-4 py-3 flex items-center justify-between border-b border-gray-200 dark:border-gray-800">
      <div>
        <h2 class="text-lg md:text-xl font-semibold text-gray-900 dark:text-gray-100 tracking-tight">Data Overview</h2>
        <p class="text-xs text-gray-500 dark:text-gray-400">Distribution of rows across tables</p>
      </div>
      <button type="button" id="dashboardChartRefresh" class="inline-flex items-center gap-2 text-sm md:text-[13px] px-3 py-1.5 md:px-3.5 md:py-2 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
        <svg class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M3 10a7 7 0 111.342 4.121l1.42-1.02A5 5 0 1010 5v2L6 3l4-4v2a8 8 0 11-7 9z"/></svg>
        Refresh
      </button>
    </div>
    <div class="p-4">
      <!-- Chart host; data is embedded to avoid inline scripts -->
      <div id="chart-table-distribution" class="relative w-full h-64 md:h-72 xl:h-80"
           data-stats='[
           {% for stat in table_stats %}{% if not forloop.first %},{% endif %}{"label":"{{ stat.label|escapejs }}","count":{{ stat.count|default:0 }}}{% endfor %}
           ]'>
        <div class="text-sm text-gray-500 dark:text-gray-400">Preparing chartâ¦</div>
      </div>
    </div>
  </div>

  <!-- Admin (Table1) Overview - read-only cards populated by dashboard.js if container exists -->
  <h2 class="text-xl font-semibold text-blue-700 dark:text-blue-300 mt-10 mb-3">Admins Overview</h2>
  <div id="admin-overview" class="bg-white dark:bg-gray-800 rounded shadow border border-gray-200 dark:border-gray-700 p-3">
    <div class="text-sm text-gray-500">Loading admins overviewâ¦</div>
  </div>

   <!-- Read-only Activity Logs section (server-rendered; no JS; placed directly under overview) -->
   <h2 class="text-xl font-semibold text-blue-700 dark:text-blue-300 mt-10 mb-3">Activity Logs</h2> <!-- added: section heading -->
   <div class="bg-white dark:bg-gray-800 rounded shadow border border-gray-200 dark:border-gray-700"> <!-- added: container consistent with cards -->
     <div class="px-4 py-3"> <!-- added: standard inner padding -->
       <div class="overflow-x-auto"> <!-- added: horizontal scroll on small screens -->
         <table class="min-w-full text-sm w-full border-collapse text-gray-900 dark:text-gray-100"> <!-- added: reuse table classes -->
           <thead> <!-- added -->
             <tr class="text-left border-b border-gray-200 dark:border-gray-700"> <!-- added: header row styling -->
               <th class="py-2 pr-2">Time</th> <!-- added: humanized timestamp -->
               <th class="py-2 pr-2">Table</th> <!-- added -->
               <th class="py-2 pr-2">Action</th> <!-- added -->
               <th class="py-2 pr-2">Row ID</th> <!-- added -->
               <th class="py-2 pr-2">User</th> <!-- added -->
               <th class="py-2 pr-2">Name</th> <!-- added -->
               <th class="py-2 pr-2">City</th> <!-- added -->
               <th class="py-2 pr-2">Phone</th> <!-- added -->
             </tr>
           </thead>
           <tbody> <!-- added -->
             {% for x in logs_recent %} <!-- added: latest 10 logs -->
             <tr class="border-b border-gray-200 dark:border-gray-700 {% if x.is_recent %}bg-blue-50 dark:bg-blue-900/20{% endif %}"> <!-- added: soft highlight for recent -->
               <td class="py-2 pr-2">{{ x.timestamp|timesince }} ago</td> <!-- added: human-friendly time -->
               <td class="py-2 pr-2">{{ x.table_name }}</td> <!-- added -->
               <td class="py-2 pr-2">{{ x.action }}</td> <!-- added -->
               <td class="py-2 pr-2">{{ x.row_id }}</td> <!-- added -->
               <td class="py-2 pr-2">{{ x.admin_user }}</td> <!-- added -->
               <td class="py-2 pr-2">{{ x.name|default:'-' }}</td> <!-- added -->
               <td class="py-2 pr-2">{{ x.city|default:'-' }}</td> <!-- added -->
               <td class="py-2 pr-2">{{ x.phone|default:'-' }}</td> <!-- added -->
             </tr>
             {% empty %} <!-- added: empty state -->
             <tr> <!-- added -->
               <td class="py-3 text-gray-500 dark:text-gray-300" colspan="8">No activity yet.</td> <!-- added -->
             </tr>
             {% endfor %} <!-- added -->
           </tbody>
         </table>
       </div>
     </div>
   </div>

{% endblock %}
