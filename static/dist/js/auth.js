(()=>{async function oe(c){return(await fetchWithCSRF("/login/",{method:"POST",body:c})).json()}async function he(c){return(await fetchWithCSRF("/signup/",{method:"POST",body:c})).json()}async function Le(){return(await fetchWithCSRF("/logout/",{method:"POST"})).json()}window.loginUser=oe;window.signupUser=he;window.logoutUser=Le;document.addEventListener("DOMContentLoaded",()=>{let c=document.getElementById("loginForm");if(c){let r=function(x){!s||!o||!i||(x?(s.disabled=!0,s.classList.add("opacity-80","cursor-not-allowed"),o.classList.remove("hidden"),i.textContent="Signing in\u2026"):(s.disabled=!1,s.classList.remove("opacity-80","cursor-not-allowed"),o.classList.add("hidden"),i.textContent="Sign in"))};var ve=r;let e=document.getElementById("loginLoader"),t=document.getElementById("loginError"),s=document.getElementById("loginBtn"),o=document.getElementById("btnSpinner"),i=document.getElementById("btnText");c.addEventListener("submit",async x=>{x.preventDefault(),t&&(t.classList.add("hidden"),t.textContent=""),r(!0);try{let y=new FormData(c),f=(y.get("username")||"").trim(),b=y.get("password")||"";if(!f||!b){t&&(t.textContent="Please enter both username and password.",t.classList.remove("hidden")),r(!1);return}let h=await oe(y);if(h&&h.success){window.updateAriaStatus&&window.updateAriaStatus("Login successful. Redirecting to dashboard."),e&&(e.classList.remove("hidden"),e.classList.add("flex")),c.parentElement&&c.parentElement.classList.add("opacity-0","translate-y-2");try{let a=document.getElementById("loading");a||(a=document.createElement("div"),a.id="loading",a.textContent="Please wait...");let m=c&&c.closest(".w-full.max-w-lg"),ye=m&&m.parentElement||document.body,ne=c&&c.parentElement?c.parentElement:null;ne&&ne.classList.add("hidden"),a.classList.remove("hidden"),a.isConnected||ye.appendChild(a);try{a.scrollIntoView({block:"center",behavior:"smooth"})}catch{}}catch{}setTimeout(()=>{window.location.href=h.redirect||"/dashboard/"},3e3)}else{let a=h&&(h.error||h.detail)||"Invalid username or password";t&&(t.textContent=a,t.classList.remove("hidden")),window.updateAriaStatus&&window.updateAriaStatus("Login failed. "+a),c.parentElement&&(c.parentElement.classList.add("motion-safe:animate-[shake_0.3s]"),setTimeout(()=>c.parentElement.classList.remove("motion-safe:animate-[shake_0.3s]"),350))}}catch{t&&(t.textContent="Network error. Please try again.",t.classList.remove("hidden")),window.updateAriaStatus&&window.updateAriaStatus("Network error during login.")}finally{r(!1)}})}let k=document.getElementById("forgotPwdToggle"),L=document.getElementById("forgotPwdWrap"),F=document.getElementById("fpStepSend"),M=document.getElementById("fpStepOtp"),N=document.getElementById("fpStepReset"),D=document.getElementById("fpSendBtn"),R=document.getElementById("fpOtpInput"),_=document.getElementById("fpVerifyBtn"),g=document.getElementById("fpNewPassword"),w=document.getElementById("fpConfirmPassword"),A=document.getElementById("fpResetBtn"),E=document.getElementById("fpMsg"),d=document.getElementById("fpCountdown"),W=document.getElementById("fpCountdownOtp"),l=document.getElementById("fpProgressOtp"),ie=document.getElementById("fpOtpFill"),$=document.getElementById("fpOtpLive"),B=document.getElementById("password"),I=document.getElementById("loginBtn"),re=document.getElementById("fpOtpGroup"),U=[0,1,2,3,4,5].map(e=>document.getElementById("fpOtpBox"+e)).filter(Boolean),ae=document.getElementById("otpGroup"),de=[0,1,2,3,4,5].map(e=>document.getElementById("otp"+e)).filter(Boolean),ce=document.getElementById("fpOtpClear")||document.getElementById("otpClear"),p=document.getElementById("fpResendBtn"),j=document.getElementById("fpResendLabel"),le=document.getElementById("countdown"),fe=document.getElementById("progressBar"),ue=document.getElementById("progressText"),n={group:re||ae,boxes:U&&U.length?U:de,clearBtn:ce,progressFill:ie||fe,progressText:ue,countdownText:W||le},V=!1,S=null;function q(e){try{if(!$)return;$.textContent="",setTimeout(()=>{$.textContent=e},10)}catch{}}function O(){return!n.boxes||!n.boxes.length?"":n.boxes.map(e=>e&&e.value?e.value.replace(/\D/g,""):"").join("").slice(0,6)}function G(){R&&(R.value=O())}function Y(){if(!n.progressFill&&!n.progressText)return;let e=O().length,t=Math.max(0,Math.min(100,Math.round(e/6*100)));try{n.progressFill&&(n.progressFill.style.width=t+"%")}catch{}try{n.progressText&&(n.progressText.textContent=`${e}/6`)}catch{}}function pe(){(n.boxes||[]).forEach(e=>{e&&(e.value="")}),G(),Y(),n.boxes&&n.boxes[0]&&n.boxes[0].focus()}function J(){try{n.group&&(n.group.classList.add("animate-shake"),setTimeout(()=>n.group.classList.remove("animate-shake"),350)),(n.boxes||[]).forEach(e=>{e&&(e.classList.remove("ring-2","ring-green-500","border-green-500"),e.classList.add("ring-2","ring-red-500","border-red-500"),setTimeout(()=>{e.classList.remove("ring-2","ring-red-500","border-red-500")},800))})}catch{}}function me(e){if(!n.boxes||!n.boxes.length)return;let t=n.boxes[e+1];t&&t.focus()}function ge(e){if(!n.boxes||!n.boxes.length)return;let t=n.boxes[e-1];t&&t.focus()}function K(){let e=O();G(),Y(),e.length===6&&!V&&(V=!0,q("Code submitted"),setTimeout(async()=>{try{await ee()}finally{V=!1}},50))}function Q(){!n.boxes||!n.boxes.length||(n.boxes.forEach((e,t)=>{let s=()=>{e.value=(e.value||"").replace(/\D/g,"").slice(0,1)};e.addEventListener("input",o=>{s(),e.value&&me(t),K();try{let i=O().length;q(`Digit ${i} of 6 entered`)}catch{}}),e.addEventListener("keydown",o=>{o.key==="Backspace"?e.value||ge(t):o.key&&/^[0-9]$/.test(o.key)||o.key.length===1&&o.preventDefault()}),e.addEventListener("paste",o=>{o.preventDefault();let r=((o.clipboardData||window.clipboardData).getData("text")||"").replace(/\D/g,"").slice(0,6);if(!r)return;for(let f=0;f<r.length&&t+f<n.boxes.length;f++){let b=n.boxes[t+f];b&&(b.value=r[f])}let x=Math.min(t+r.length,n.boxes.length-1),y=n.boxes[x];y&&y.focus(),K()}),e.setAttribute("inputmode","numeric"),e.setAttribute("aria-label",`OTP digit ${t+1}`)}),G(),Y())}let T=null;function P(e){if(L){if([F,M,N].forEach(t=>t&&t.classList.add("hidden")),e===1&&F&&F.classList.remove("hidden"),e===2&&M){M.classList.remove("hidden");try{Q()}catch{}n.boxes&&n.boxes[0]&&n.boxes[0].focus()}e===3&&N&&N.classList.remove("hidden")}}function z(e){try{B&&(e?(B.dataset._prevDisplay=B.style.display||"",B.closest("div")?.classList.add("hidden"),B.setAttribute("disabled","disabled")):(B.closest("div")?.classList.remove("hidden"),B.removeAttribute("disabled"))),I&&(e?(I.dataset._prevDisabled="1",I.classList.add("opacity-60","cursor-not-allowed"),I.setAttribute("disabled","disabled")):(I.classList.remove("opacity-60","cursor-not-allowed"),I.removeAttribute("disabled")))}catch{}}function C(e,t,s="Working\u2026",o){if(!e)return;let i=e.querySelector("[data-text]"),r=e.querySelector("svg");e.disabled=!!t,t?(e.classList.add("opacity-80","cursor-not-allowed"),r&&r.classList.remove("hidden"),i&&(i.textContent=s)):(e.classList.remove("opacity-80","cursor-not-allowed"),r&&r.classList.add("hidden"),i&&o&&(i.textContent=o))}function u(e,t){E&&(E.textContent=t||"",E.classList.add("hidden"),E.classList.remove("text-red-600","text-green-600"),t&&(E.classList.remove("hidden"),E.classList.add(e==="error"?"text-red-600":"text-green-600")))}function v(){if(!g||!w)return;let e=document.getElementById("fpPwMatchIcon"),t=document.getElementById("fpPwNewIconOk"),s=document.getElementById("fpPwNewIconBad"),o=document.getElementById("fpPwConfirmIconBad"),i=(g.value||"").trim(),r=(w.value||"").trim(),x=i.length>=8,y=r.length>=8,f=x&&y&&i===r;try{e&&e.classList.toggle("hidden",!f),t&&t.classList.toggle("hidden",!(f&&x)),s&&s.classList.toggle("hidden",!(r.length>0&&i.length>0&&!f)),o&&o.classList.toggle("hidden",!(r.length>0&&!f));let b=["ring-2","ring-green-500","border-green-500"],h=["ring-2","ring-red-500","border-red-500"];g.classList.remove("ring-2","ring-green-500","border-green-500","ring-red-500","border-red-500"),w.classList.remove("ring-2","ring-green-500","border-green-500","ring-red-500","border-red-500"),i.length>0&&(f?b.forEach(m=>g.classList.add(m)):r.length>0&&h.forEach(m=>g.classList.add(m))),r.length>0&&(f?b.forEach(m=>w.classList.add(m)):h.forEach(m=>w.classList.add(m)));let a=document.getElementById("fpResetBtn");a&&(f?(a.removeAttribute("disabled"),a.classList.remove("opacity-60","cursor-not-allowed")):(a.setAttribute("disabled","disabled"),a.classList.contains("opacity-60")||a.classList.add("opacity-60"),a.classList.contains("cursor-not-allowed")||a.classList.add("cursor-not-allowed")))}catch{}}function X(e){if(!d&&!W&&!l&&!n.countdownText)return;T&&clearInterval(T);let t=e;d&&(d.textContent=`Expires in ${t}s`,d.classList.remove("hidden"),d.classList.remove("text-red-600","text-yellow-600","text-green-600","animate-pulse"),d.classList.add("text-green-600"));let s=n.countdownText||W;s&&(s.textContent=`Expires in ${t}s`,s.classList?.remove("text-red-600","text-yellow-600","text-green-600","animate-pulse"),s.classList?.add("text-green-600")),l&&(l.style.width="100%",l.classList.remove("bg-red-600","bg-yellow-500","bg-blue-600"),l.classList.add("bg-blue-600")),T=setInterval(()=>{if(t-=1,t<=0){clearInterval(T),T=null,d&&(d.textContent="Code expired. Request a new one.",d.classList.remove("text-green-600","text-yellow-600"),d.classList.add("text-red-600"),d.classList.remove("animate-pulse")),s&&(s.textContent="Code expired",s.classList?.remove("text-green-600","text-yellow-600"),s.classList?.add("text-red-600"),s.classList?.remove("animate-pulse")),l&&(l.style.width="0%",l.classList.remove("bg-blue-600","bg-yellow-500"),l.classList.add("bg-red-600"));try{sessionStorage.removeItem("fpOtpExpiry")}catch{}return}if(d&&(d.textContent=`Expires in ${t}s`),s&&(s.textContent=`Expires in ${t}s`),l){let o=Math.max(0,Math.min(100,Math.round(t/e*100)));l.style.width=o+"%"}t<=30?(d&&(d.classList.remove("text-green-600","text-yellow-600"),d.classList.add("text-red-600","animate-pulse")),s&&(s.classList?.remove("text-green-600","text-yellow-600"),s.classList?.add("text-red-600","animate-pulse")),l&&(l.classList.remove("bg-blue-600","bg-yellow-500"),l.classList.add("bg-red-600"))):t<=120&&(d&&(d.classList.remove("text-green-600"),d.classList.add("text-yellow-600"),d.classList.remove("animate-pulse")),s&&(s.classList?.remove("text-green-600"),s.classList?.add("text-yellow-600"),s.classList?.remove("animate-pulse")),l&&(l.classList.remove("bg-blue-600"),l.classList.add("bg-yellow-500")))},1e3)}async function Z(){E&&u("info",""),C(D,!0,"Sending\u2026","Send OTP");try{let t=await(await fetchWithCSRF("/Super-Admin/auth/password-reset/request/",{method:"POST"})).json();showNotification("If an account exists, an OTP has been sent.","info"),P(2);try{sessionStorage.setItem("fpOtpExpiry",String(Date.now()+600*1e3))}catch{}X(600);try{v()}catch{}se(30)}catch{u("error","Network error. Try again.")}finally{C(D,!1,"Sending\u2026","Send OTP")}}async function ee(){u("info","");let e=(R&&R.value||O()||"").trim();if(!/^\d{6}$/.test(e)){u("error","Please enter a valid 6-digit code."),J();return}C(_,!0,"Verifying\u2026","Verify Code");try{let t=new FormData;t.append("code",e);let o=await(await fetchWithCSRF("/Super-Admin/auth/password-reset/verify-otp/",{method:"POST",body:t})).json();if(o&&o.ok&&o.verified){showNotification("OTP verified. You can set a new password now.","success"),P(3);try{sessionStorage.removeItem("fpOtpExpiry")}catch{}try{v()}catch{}}else u("error","Incorrect or expired code. Try again."),J(),q("Code incorrect or expired")}catch{u("error","Network error. Try again.")}finally{C(_,!1,"Verifying\u2026","Verify Code")}}async function we(){u("info","");let e=g&&g.value||"",t=w&&w.value||"";if(!e||e.length<8){u("error","Password must be at least 8 characters.");return}if(t!==e){u("error","Passwords do not match.");return}C(A,!0,"Updating\u2026","Reset Password");try{let s=new FormData;s.append("new_password",e);let i=await(await fetchWithCSRF("/Super-Admin/auth/password-reset/confirm/",{method:"POST",body:s})).json();i&&i.ok&&i.reset?(u("success","\u2714 Password reset successful. You can now sign in."),showNotification("Password reset successful. Please sign in.","success"),setTimeout(()=>{P(1),L&&L.classList.add("hidden"),z(!1);try{g.value="",w.value="",v()}catch{}},4e3)):u("error",i&&i.error||"Unable to reset password.")}catch{u("error","Network error. Try again.")}finally{C(A,!1,"Updating\u2026","Reset Password")}}k&&L&&k.addEventListener("click",e=>{e.preventDefault(),L.classList.toggle("hidden"),P(1),u("info","");let t=!L.classList.contains("hidden");if(z(t),t)try{v()}catch{}}),D&&D.addEventListener("click",e=>{e.preventDefault(),Z()}),_&&_.addEventListener("click",e=>{e.preventDefault(),ee()}),A&&A.addEventListener("click",e=>{e.preventDefault(),we()});let te=e=>{e&&(e.addEventListener("input",v),e.addEventListener("keyup",v),e.addEventListener("change",v),e.addEventListener("paste",()=>setTimeout(v,0)))};te(g),te(w),n.clearBtn&&n.clearBtn.addEventListener("click",e=>{e.preventDefault(),pe()});function H(e,t){!p||!j||(e?(p.removeAttribute("disabled"),p.classList.remove("cursor-not-allowed","opacity-60"),j.textContent="Resend OTP"):(p.setAttribute("disabled","disabled"),p.classList.contains("cursor-not-allowed")||p.classList.add("cursor-not-allowed"),p.classList.contains("opacity-60")||p.classList.add("opacity-60"),j.textContent=`Resend in ${t}s`))}function se(e){if(!p)return;let t=e;S&&clearInterval(S),H(!1,t),S=setInterval(()=>{t-=1,t<=0?(clearInterval(S),S=null,H(!0,0)):H(!1,t)},1e3)}p&&p.addEventListener("click",async e=>{e.preventDefault(),!p.hasAttribute("disabled")&&await Z()});try{let e=sessionStorage.getItem("fpOtpExpiry"),t=e?parseInt(e,10):0,s=Date.now();if(t&&t>s){let o=t-s,i=Math.max(1,Math.floor(o/1e3));L&&L.classList.remove("hidden"),P(2),Q(),z(!0),X(i),se(15)}}catch{}});})();
//# sourceMappingURL=auth.js.map
